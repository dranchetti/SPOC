/*! SPOC 15-01-2016 */
!function(a,b,c,d){"use strict";c.Utils={},c.SP={},c.Yam={},c.Utils.Conversion={},c.Utils.Conversion.objToQueryString=function(a){var b="";for(var c in a)b+="&$"+c+"="+a[c].replace(/ /g,"_x0020_");return encodeURI(b)},c.Mock={active:!1,db:{}},b.addEventListener("DOMContentLoaded",function(a){_spPageContextInfo&&(_spPageContextInfo={}),SP||(c.Mock.active=!0)}),c.Mock.createList=function(a,b){c.Mock.db[a.toLowerCase()]=b},c.Utils.Objects={},c.Utils.Objects.findObjectByProperty=function(a,b,c){var d;for(d=0;d<a.length;d++)if(a[d][b]===c)return a[d];return!1},c.Utils.Objects.merge=function(a,b){for(var c in b)try{b[c].constructor==Object?a[c]=MergeRecursive(a[c],b[c]):a[c]=b[c]}catch(d){a[c]=b[c]}return a},c.Utils.Request={},c.Utils.Request.get=function(a,b){return new Promise(function(d,e){var f=c.Utils.Storage.get("SPOC-"+a);if(f&&!b)d(f);else if(c.Mock.active){a=c.Utils.Url.getListNameFromUrl(a);var g=c.Mock.db[a];d(g?g:{error:"no mock data found for the list - "+a})}else{!c.Utils.Url.isSameDomain(a)&&a.toLowerCase().indexOf("_api/web")>-1&&(a=c.Utils.Url.convertToXDomain(a));var h=new XMLHttpRequest;h.open("GET",a,!0),h.setRequestHeader("Accept","application/json;odata=verbose"),h.onreadystatechange=function(){if(4==h.readyState)if(200==h.status){var b=JSON.parse(h.responseText);b=b.d.results?b.d.results:b.d,c.Utils.Storage.set("SPOC-"+a,b),d(b)}else e(Error(JSON.parse(h.statusText)))},h.onerror=function(a){e(Error("Network Error"))},h.send()}})},c.Utils.Request.post=function(a,d,e){return new Promise(function(f,g){if(c.Mock.active)f(d);else{!c.Utils.Url.isSameDomain(a)&&a.toLowerCase().indexOf("_api/web")>-1&&(a=c.Utils.Url.convertToXDomain(a));var h=new XMLHttpRequest;h.open("POST",a,!0),h.setRequestHeader("Accept","application/json;odata=verbose"),h.setRequestHeader("X-RequestDigest",b.getElementById("__REQUESTDIGEST").value),h.setRequestHeader("Content-Type","application/json;odata=verbose"),e&&h.setRequestHeader("content-length",d.byteLength),h.onreadystatechange=function(){4==h.readyState&&(200==h.status?f(d):g(Error(h.statusText)))},h.onerror=function(a){g(Error("Network Error"))},h.send(e?d:JSON.stringify(d))}})},c.Utils.Request.put=function(a,d){return new Promise(function(e,f){if(c.Mock.active)e(d);else{!c.Utils.Url.isSameDomain(a)&&a.toLowerCase().indexOf("_api/web")>-1&&(a=c.Utils.Url.convertToXDomain(a));var g=new XMLHttpRequest;g.open("POST",a,!0),g.setRequestHeader("Accept","application/json;odata=verbose"),g.setRequestHeader("X-RequestDigest",b.getElementById("__REQUESTDIGEST").value),g.setRequestHeader("Content-Type","application/json;odata=verbose"),g.setRequestHeader("X-HTTP-Method","MERGE"),g.setRequestHeader("If-Match","*"),g.onreadystatechange=function(){4==g.readyState&&(200==g.status?e(d):f(Error(g.statusText)))},g.onerror=function(a){f(Error("Network Error"))},g.send(JSON.stringify(d))}})},c.Utils.Request.loadScript=function(a,c,d){new Promise(function(c,d){var e=b.createElement("script");e.src=a,e.addEventListener("load",function(){c(a)},!1),e.addEventListener("error",function(){d(a)},!1),b.body.appendChild(e)})},c.Utils.SP={},c.Utils.SP.getListItemType=function(a){return a=a[0].toUpperCase()+a.substring(1),"SP.Data."+a.replace(/ /g,"_x0020_")+"ListItem"},c.Utils.SP.isAppWeb=function(){return a.location.href.toLowerCase().indexOf("sphosturl")>-1?!0:!1},c.Utils.SP.convertToWebApp=function(a){if(a.toLowerCase().indexOf("WopiFrame.aspx")>-1)return a;var b=c.Utils.Strings.getFileExtension(a);return"docx"===b||"pptx"===b||"xlsx"===b?site.url+"/_layouts/15/WopiFrame.aspx?sourcedoc="+a:a},c.Utils.SP.formatSearchResponse=function(a){var b,c,d,e,f=a.query.PrimaryQueryResult.RelevantResults.Table.Rows,g=[];for(f=f.results?f.results:[f],d=0;d<f.length;d++){for(b=f[d].Cells.results,c={},e=0;e<b.length;e++)c[b[e].Key]=b[e].Value;g.push(c)}return g},c.Utils.Storage={},c.Utils.Storage.storageAvailable=function(){return"undefined"!=typeof Storage},c.Utils.Storage.set=function(a,b,d){if(c.Utils.Storage.storageAvailable()){var e=d?localStorage:sessionStorage;e.setItem(a,b===Object(b)?JSON.stringify(b):b)}},c.Utils.Storage.get=function(a,b){if(c.Utils.Storage.storageAvailable()){var d=b?localStorage:sessionStorage;return JSON.parse(d.getItem(a))}return null},c.Utils.Storage.remove=function(a,b){if(c.Utils.Storage.storageAvailable()){b?localStorage:sessionStorage;localStorage.removeItem(a)}},c.Utils.Storage.getCookie=function(a){a+="=";for(var c=b.cookie.split(";"),d=0;d<c.length;d++){var e=c[d].trim();if(0===e.indexOf(a))return e.substring(a.length,e.length)}return!1},c.Utils.Storage.setCookies=function(a,c,d){var e;if(d){var f=new Date;f.setTime(f.getTime()+24*d*60*60*1e3),e="; expires="+f.toGMTString()}else e="";b.cookie=a+"="+c+"; "+e},c.Utils.Storage.removeCookies=function(a){c.Utils.Storage.setCookies(a,"",-1)},c.Utils.Strings={},c.Utils.Strings.cut=function(a,b){return a.length>b?title.substr(0,b-3)+"...":a.length},c.Utils.Strings.getFileExtension=function(a){return a.split(".").pop()},c.Utils.Tpl={},c.Utils.Tpl.getProperty=function(a,b){var c,d=a.split("."),e=d.length,f=b||this;for(c=0;e>c;c++)f=f[d[c]];return f},c.Utils.Tpl.render=function(a,b){var d=/{{(.*?)}}/g,e=a.match(d);if(e&&e.length)for(var f=0,g=e.length;g>f;f++)a=a.replace(new RegExp(e[f],"g"),c.Utils.Tpl.getProperty(e[f].replace(/{{|}}/g,""),b));return a},c.Utils.Url={},c.Utils.Url.getQueryString=function(b,c){c=c?c.split("?")[1]:a.location.search.substring(1);for(var d=c.split("&"),e=0;e<d.length;e++){var f=d[e].split("=");if(f[0]==b)return unescape(f[1])}},c.Utils.Url.getListNameFromUrl=function(a){var b=/\%27(.*)\%27/g,c=b.exec(a);return c?c[1]:null},c.Utils.Url.isSameDomain=function(b){var c=a.location.origin.toLowerCase();return b.toLowerCase().indexOf(c)>-1?!0:!1},c.Utils.Url.convertToXDomain=function(b){b=b.toLowerCase(),b=b.replace("/_api/","/_api/SP.AppContextSite(@target)/");var c=b.split("/_api")[0];return b=b.split("/_api")[1],-1===b.indexOf("?")&&(b+="?"),b=a.location.origin+"/_api"+b+"@target=%27"+c+"%27"},c.Utils.Yammer={},c.Utils.Yammer.formatFeedResponse=function(a){var b,d=[];for(b=0;b<a.messages.length;b++)a.messages[b].replied_to_id||a.messages[b].sender_type&&"user"===a.messages[b].sender_type&&(a.messages[b].user=c.Utils.Arrays.findByProperty(a.references,"id",a.messages[b].sender_id),d.push(a.messages[b]));return d},c.Utils.Yammer.formatSearchResponse=function(a){var b;if(a.messages&&a.messages.messages)for(b=0;b<a.messages.messages.length;b++){var d=a.messages.messages[b];d.sender_type&&"user"===d.sender_type&&(d.user=c.Utils.Arrays.findByProperty(a.messages.references,"id",d.sender_id))}return a},c.Utils.Yammer.checkLogin=function(a){return new Promise(function(b,c){yam.getLoginStatus(function(c){c.authResponse?deferred.resolve(c):a?yam.platform.login(function(a){b(a?a:!1)}):b(c)})})},c.SP.Site=function(a){this.url=a?a:_spPageContextInfo.webAbsoluteUrl},c.SP.User=function(a){this.id=a?a:_spPageContextInfo.userId,this.loginName=a?a:_spPageContextInfo.userLoginName},c.Yam.User=function(b){a.yam||console.log("Please ensure that you have included Yammer SDK and added a valid Client Id"),this.id=b?b:"current"},c.Yam.Feed=function(b,c){a.yam||console.log("Please ensure that you have included Yammer SDK and added a valid Client Id"),this.feedId=b,this.feedType=c},c.SP.Site.prototype.Delve=function(a){var b=this,d={};return d.board=function(d,e,f){return new Promise(function(g,h){var i,j;d||(d="*"),a?(i=b.url+"/_api/search/query?Querytext=%27WorkEmail:"+a+"%27&SelectProperties=%27UserName,DocId%27",c.Utils.Request.get(i,f).then(function(a){a=c.Utils.SP.formatSearchResponse(a),a.length?(a.length>1&&(a=a[0]),j=a.DocId,i=b.url+"/_api/search/query?Querytext='"+d+"'&amp;Properties='GraphQuery:ACTOR("+j+e?", "+e:")",c.Utils.Request.get(i,f).then(function(a){a=c.Utils.SP.formatSearchResponse(a),g(a)},function(a){h(a)})):g(null)},function(a){h(a)})):(i=b.url+"/_api/search/query?Querytext='"+d+"'&amp;Properties='GraphQuery:ACTOR(ME"+e?", "+e:")",c.Utils.Request.get(i,f).then(function(a){a=c.Utils.SP.formatSearchResponse(a),g(a)},function(a){h(a)}))})},d},c.SP.Site.prototype.Files=function(b){var d=this,e={};return"/"!==b.charAt(0)&&(b="/"+b),e.generateExternalLink=function(a){a=a?a:24;var e=d.url+"/_api/Web/GetFileByServerRelativeUrl('"+b+"')/GetPreAuthorizedAccessUrl("+a+")";return c.Utils.Request.get(e,!0)},e.uploadViaModal=function(a){return new Promise(function(b,c){var e={};e.url=d.url+"/_layouts/Upload.aspx?List="+a+"&IsDlg=1",e.dialogReturnValueCallback=Function.createDelegate(null,function(a,c){b(c)}),SP.UI.ModalDialog.showModalDialog(e)})},e.upload=function(a){return new Promise(function(e,f){var g=new FileReader;g.onloadend=function(g){var h=a.value.split("\\"),i=h[h.length-1],j=d.url+"/_api/Web/GetFolderByServerRelativeUrl('"+b+"')/files/add(overwrite=true, url='"+i+"')";c.Utils.Request.post(j,g.target.result,!0).then(function(a){e(a)},function(a){f(a)})},g.onerror=function(a){f(a.target.error)},g.readAsArrayBuffer(a.files[0])})},e.query=function(a){var e=d.url+"/_api/web/getfilebyserverrelativeurl('"+b+"')/ListItemAllFields";return c.Utils.Request.get(e,a)},e.download=function(){a.open("/_layouts/download.aspx?SourceUrl="+d.url+b)},e.openInWebApps=function(e){var f=d.url+b;e?a.open(c.Utils.SP.convertToWebApp(f)):a.location.href=c.Utils.SP.convertToWebApp(f)},e},c.SP.Site.prototype.ListItems=function(a){var b=this,d={};return d.query=function(d,e,f){var g=b.url+"/_api/web/lists/getByTitle%28%27"+a+"%27%29/items";return g+=d?"?"+c.Utils.Conversion.objToQueryString(d):"",c.Utils.Request.get(g,e)},d.create=function(d){var e=b.url+"/_api/web/lists/getByTitle%28%27"+a+"%27%29/items",f={__metadata:{type:c.Utils.SP.getListItemType(a)}};return d&&(f=c.Utils.Objects.merge(f,d)),c.Utils.Request.post(e,f)},d.update=function(d,e){var f=b.url+"/_api/web/lists/getByTitle%28%27"+a+"%27%29/items("+d+")",g={__metadata:{type:c.Utils.SP.getListItemType(a)}};return e&&(g=c.Utils.Objects.merge(g,e)),c.Utils.Request.put(f,g)},d},c.SP.Site.prototype.Lists=function(a){var b=this,d={};return d.query=function(d,e){var f=b.url+"/_api/web/lists/getByTitle%28%27"+a+"%27%29/";return f+=d?"?"+c.Utils.Conversion.objToQueryString(d):"",c.Utils.Request.get(f,e)},d.create=function(a){var d={__metadata:{type:"SP.List"},BaseTemplate:100,Description:""};a&&(d=c.Utils.Objects.merge(d,a));var e=b.url+"/_api/web/lists";return c.Utils.Request.post(e,d)},d},c.SP.Site.prototype.Search=function(a){var b=this,d={};return d.query=function(d,e){return new Promise(function(f,g){var h=b.url+"/_api/search/query?querytext=%27"+a+" +path:"+b.url+"%27";h+=d?"?"+c.Utils.Conversion.objToQueryString(d):"",c.Utils.Request.get(h,e).then(function(a){a=c.Utils.SP.formatSearchResponse(a),f(a)},function(a){g(a)})})},d},c.SP.User.prototype.Profile=function(){var a=this,b={},d="i:0%23.f|membership|";return b.query=function(b){var e=_spPageContextInfo.webAbsoluteUrl;return e+=a.loginName?"/_api/SP.UserProfiles.PeopleManager/GetPropertiesFor(accountName=@v)?@v=%27"+d+a.loginName+"%27":"/_api/SP.UserProfiles.PeopleManager/GetMyProperties/UserProfileProperties",c.Utils.Request.get(e,b)},b.isMemberOfGroup=function(a,b,d){var e=b?b:_spPageContextInfo.userId,f=site.url+"/_api/web/sitegroups/getByName('"+a+"')/Users?$filter=Id eq "+e;return c.Utils.Request.get(f,d)},b},c.Yam.Feed.prototype.posts=function(){var a=this,b={},d="messages/following.json";return a.feedId&&(d="in_group"),b.query=function(a){return new Promise(function(b,e){c.Utils.Yammer.checkLogin().then(function(f){f?yam.platform.request({url:d,method:"GET",data:a?a:null,success:function(a){a=c.Utils.Yammer.formatFeedResponse(a),b(a)},error:function(a){e(a)}}):b(!1)})})},b},c.Yam.Search=function(){var a={},b="search.json";return a.query=function(a,d){return new Promise(function(d,e){c.Utils.Yammer.checkLogin().then(function(f){f?yam.platform.request({url:b,method:"GET",data:a?a:null,success:function(b){b=c.Utils.Yammer.formatSearchResponse(b),c.Utils.Storage.set("SPOC-yam-search-"+JSON.stringify(a),b),d(b)},error:function(a){e(a)}}):d(!1)})})},a},c.Yam.User.prototype.Subscriptions=function(){var a=this,b={};return b.query=function(b,d){return new Promise(function(d,e){c.Utils.Yammer.checkLogin().then(function(f){f?yam.platform.request({url:"subscriptions/to_user/"+a.id+".json",method:"GET",data:b?b:null,success:function(b){c.Utils.Storage.set("SPOC-yam-subs-"+a.id,b),d(b)},error:function(a){e(a)}}):d(!1)})})},b},c.Yam.User.prototype.Profile=function(){var a=this,b={};return b.query=function(b,d){return new Promise(function(d,e){c.Utils.Yammer.checkLogin().then(function(f){f?yam.platform.request({url:"users/"+a.id+".json",method:"GET",data:b?b:null,success:function(b){c.Utils.Storage.set("SPOCC-yam-users-"+a.id,b),d(b)},error:function(a){e(a)}}):d(!1)})})},b}}(window,document,window.SPOC=window.SPOC||{});